name: Update Weather Data

on:
  schedule:
    - cron: '*/10 * * * *' # Runs every 10 minutes
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

       - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libeccodes-dev eccodes  <-- ERROR IS HERE

      - name: Install Python Dependencies
        run: |
          # Added 'scipy' to the end of this list
          pip install numpy xarray cfgrib matplotlib requests beautifulsoup4 pillow scipy

      - name: Rotate Old Data
        run: |
          # Create directories if they don't exist
          mkdir -p public/data/tiles_0
          
          # Only rotate if we have existing data
          if [ -f "public/data/metadata_0.json" ]; then
            echo "Rotating history frames..."
            for i in {8..0}; do
              next=$((i+1))
              # Move Tiles
              [ -d "public/data/tiles_$i" ] && rm -rf "public/data/tiles_$next" && mv "public/data/tiles_$i" "public/data/tiles_$next" || true
              # Move Images
              [ -f "public/data/master_$i.png" ] && mv "public/data/master_$i.png" "public/data/master_$next.png" || true
              # Handle the special case for the current master.png
              if [ $i -eq 0 ] && [ -f "public/data/master.png" ]; then
                mv "public/data/master.png" "public/data/master_1.png"
              fi
              # Move Metadata
              [ -f "public/data/metadata_$i.json" ] && mv "public/data/metadata_$i.json" "public/data/metadata_$next.json" || true
            done
          fi
          mkdir -p public/data/tiles_0

      - name: Run Processing Script
        run: python scripts/process_mrms.py

      - name: Commit and Push
        run: |
          git config --global user.name "weather-bot"
          git config --global user.email "bot@weather.com"
          git add public/data/*
          git commit -m "Update radar data: $(date)" || echo "No changes to commit"
          git push origin main
