<!DOCTYPE html>
<html>
<head>
    <title>Live P-Type Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #111; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.9); padding: 15px;
            border-radius: 30px; display: flex; align-items: center; gap: 20px; color: white;
            border: 1px solid #444;
        }
        .legend {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; color: white; font-size: 12px;
        }
        input[type=range] { width: 200px; cursor: pointer; }
        button { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; border-radius: 15px; cursor: pointer; }
        button:hover { background: #555; }
    </style>
</head>
<body>
    <div class="legend">
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px;height:12px;background:#00ff00;display:block"></span> Rain</div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px;height:12px;background:#ff00ff;display:block"></span> Mix</div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:12px;height:12px;background:#00ccff;display:block"></span> Snow</div>
    </div>
    <div class="controls">
        <button id="playBtn" onclick="togglePlay()">Play</button>
        <input type="range" id="loopSlider" min="0" max="4" value="0" oninput="setFrame(this.value)">
        <span id="timeLabel">Live</span>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([38, -97], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let radarLayers = [L.layerGroup(), L.layerGroup(), L.layerGroup(), L.layerGroup(), L.layerGroup()];
        radarLayers.forEach(l => l.addTo(map));

        let isPlaying = false;
        let loopTimer;

        async function loadFrames() {
            for(let i=0; i<5; i++) {
                try {
                    const r = await fetch(`data/metadata_${i}.json?t=${Date.now()}`);
                    const d = await r.json();
                    renderFrame(d, i);
                } catch(e) { console.log("Frame " + i + " not ready yet"); }
            }
            setFrame(0); // Start at live
        }

        function renderFrame(data, idx) {
            radarLayers[idx].clearLayers();
            const [s, w] = data.bounds[0];
            const [n, e] = data.bounds[1];
            const latR = n - s; const lonR = e - w;

            data.tiles.forEach(t => {
                const ts = n - ((t.row + 1) * (latR / 4));
                const tn = n - (t.row * (latR / 4));
                const tw = w + (t.col * (lonR / 4));
                const te = w + ((t.col + 1) * (lonR / 4));
                L.imageOverlay(t.url, [[ts, tw], [tn, te]], {opacity: 0.8}).addTo(radarLayers[idx]);
            });
        }

        function setFrame(val) {
            radarLayers.forEach((l, i) => l.setZIndex(i == val ? 100 : 0));
            radarLayers.forEach((l, i) => {
                 const opacity = (i == val) ? 0.8 : 0;
                 l.eachLayer(layer => layer.setOpacity(opacity));
            });
            document.getElementById('timeLabel').innerText = val == 0 ? "Live" : `-${val * 10}m`;
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').innerText = isPlaying ? "Pause" : "Play";
            if(isPlaying) {
                let cur = 4;
                loopTimer = setInterval(() => {
                    setFrame(cur);
                    document.getElementById('loopSlider').value = cur;
                    cur = cur <= 0 ? 4 : cur - 1;
                }, 600);
            } else { clearInterval(loopTimer); }
        }

        loadFrames();
    </script>
</body>
</html>
