<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MRMS Precip Type</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html, body, #map { height:100%; margin:0; background:#111 }
.controls {
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:white;
  padding:12px;
  border-radius:8px;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:1000;
}
input[type=range] { width:160px }
</style>
</head>

<body>
<div id="map"></div>

<div class="controls">
  <button id="play">▶</button>
  <input id="slider" type="range" min="0" max="4" value="0">
  <span id="time">--</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map", { center:[38,-97], zoom:4 });
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"
).addTo(map);

let scans = [];
let layerGroup = L.layerGroup().addTo(map);
let frame = 0;
let playing = false;

fetch("data/metadata.json")
.then(r=>r.json())
.then(data=>{
  scans = data;
  document.getElementById("slider").max = scans.length-1;
  render(0);
});

function render(i){
  layerGroup.clearLayers();
  const s = scans[i];
  const [[lat1, lon1],[lat2, lon2]] = s.bounds;
  document.getElementById("time").innerText = s.time;

  s.tiles.forEach(t=>{
    const latStep = (lat2-lat1)/4;
    const lonStep = (lon2-lon1)/4;

    const south = lat2 - (t.row+1)*latStep;
    const north = lat2 - t.row*latStep;
    const west = lon1 + t.col*lonStep;
    const east = lon1 + (t.col+1)*lonStep;

    L.imageOverlay(
      `data/${s.path}/${t.url}`,
      [[south, west],[north, east]],
      { opacity:.85 }
    ).addTo(layerGroup);
  });
}

document.getElementById("slider").oninput = e=>{
  frame = +e.target.value;
  render(frame);
};

document.getElementById("play").onclick = ()=>{
  playing = !playing;
  document.getElementById("play").innerText = playing ? "⏸" : "▶";
};

setInterval(()=>{
  if(!playing || !scans.length) return;
  frame = (frame + 1) % scans.length;
  document.getElementById("slider").value = frame;
  render(frame);
}, 1000);
</script>
</body>
</html>
