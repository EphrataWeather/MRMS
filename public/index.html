<!DOCTYPE html>
<html>
<head>
    <title>Live MRMS Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #111; font-family: sans-serif; color: white; }
        #map { height: 100vh; width: 100%; }
        #controls {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: rgba(20, 20, 20, 0.9); padding: 20px; border-radius: 8px;
            width: 250px; border: 1px solid #333;
        }
        select, button { width: 100%; padding: 10px; margin: 8px 0; border-radius: 4px; border: none; cursor: pointer; }
        button { background: #007bff; color: white; font-weight: bold; }
        #time-display { text-align: center; font-family: monospace; font-size: 1.2em; color: #00ffcc; margin: 10px 0; }
        .slider { width: 100%; margin: 10px 0; }
    </style>
</head>
<body>

<div id="controls">
    <div id="status" style="font-size: 0.8em; color: #aaa;">Status: Ready</div>
    <select id="prodSelect" onchange="loadManifest()">
        <option value="reflectivity">Radar Reflectivity</option>
        <option value="precip">Precipitation Rate</option>
    </select>
    <div id="time-display">--:--:--</div>
    <input type="range" id="scrubber" class="slider" min="0" max="0" value="0" oninput="showFrame(this.value)">
    <button id="playBtn" onclick="togglePlay()">Play Loop</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([38, -95], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    let currentManifest = null;
    let mapLayers = [];
    let currentIndex = 0;
    let playTimer = null;

    async function loadManifest() {
        const status = document.getElementById('status');
        status.innerText = "Status: Loading Manifest...";
        
        try {
            // Fetch the static JSON file created by GitHub Actions
            const response = await fetch('manifest.json?t=' + Date.now()); // Prevent caching
            currentManifest = await response.json();
            
            updateMapLayers();
            status.innerText = "Status: Data Updated";
        } catch (e) {
            status.innerText = "Status: Error loading data";
            console.error("Manifest error:", e);
        }
    }

    function updateMapLayers() {
        const type = document.getElementById('prodSelect').value;
        const frames = currentManifest[type];

        // Clear existing layers
        mapLayers.forEach(l => map.removeLayer(l));
        mapLayers = [];

        if (!frames || frames.length === 0) return;

        // Create new layers (all hidden initially)
        frames.forEach(f => {
            const layer = L.imageOverlay(f.url, f.bounds, { opacity: 0 });
            layer.addTo(map);
            mapLayers.push(layer);
        });

        document.getElementById('scrubber').max = frames.length - 1;
        showFrame(frames.length - 1); // Show latest
    }

    function showFrame(idx) {
        currentIndex = parseInt(idx);
        const type = document.getElementById('prodSelect').value;
        const frames = currentManifest[type];

        mapLayers.forEach((layer, i) => {
            layer.setOpacity(i == currentIndex ? 0.8 : 0);
        });

        const timeStr = frames[currentIndex].time; // e.g., 20260201-175000
        const timeFormatted = timeStr.split('-')[1].match(/.{1,2}/g).join(':') + " Z";
        document.getElementById('time-display').innerText = timeFormatted;
        document.getElementById('scrubber').value = currentIndex;
    }

    function togglePlay() {
        const btn = document.getElementById('playBtn');
        if (playTimer) {
            clearInterval(playTimer);
            playTimer = null;
            btn.innerText = "Play Loop";
        } else {
            btn.innerText = "Stop Loop";
            playTimer = setInterval(() => {
                currentIndex = (currentIndex + 1) % mapLayers.length;
                showFrame(currentIndex);
            }, 600);
        }
    }

    // Initial load
    loadManifest();
</script>
</body>
</html>
