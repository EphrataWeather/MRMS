<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live MRMS Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #080808; font-family: -apple-system, sans-serif; color: white; }
        #map { height: 100vh; width: 100%; }
        .controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: rgba(0,0,0,0.85);
            padding: 15px; border-radius: 12px; z-index: 1000;
            display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(5px); border: 1px solid #333;
        }
        button { background: #00fb90; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        input[type=range] { flex-grow: 1; accent-color: #00fb90; }
        #time-label { min-width: 80px; text-align: right; font-family: monospace; font-size: 14px; }
        #status {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.7); padding: 5px 10px; font-size: 12px;
            border-radius: 4px; color: #00fb90;
        }
    </style>
</head>
<body>

    <div id="status">Initializing...</div>

    <div class="controls">
        <button id="playBtn">Pause</button>
        <input type="range" id="scrubber" min="0" value="0">
        <div id="time-label">--:--</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([38.5, -96.5], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let frames = [];
        let currentIndex = 0;
        let isPlaying = true;
        let radarLayer = L.layerGroup().addTo(map);

        // This detects if we are on GitHub Pages or local
        const BASE_PATH = window.location.pathname.includes('MRMS') ? '/MRMS/public/data/' : 'public/data/';

        async function loadFrames() {
            const tempFrames = [];
            const timestamp = Date.now();
            document.getElementById('status').innerText = "Syncing Radar...";

            for (let i = 0; i < 10; i++) {
                try {
                    // FIX: Changed from metadata.json to metadata_i.json
                    const metaUrl = `${BASE_PATH}metadata_${i}.json?t=${timestamp}`;
                    const res = await fetch(metaUrl);
                    
                    // Only try to parse if the response is actually JSON
                    const contentType = res.headers.get("content-type");
                    if (res.ok && contentType && contentType.includes("application/json")) {
                        const meta = await res.json();
                        const imgUrl = (i === 0 ? `${BASE_PATH}master.png` : `${BASE_PATH}master_${i}.png`) + `?t=${timestamp}`;
                        tempFrames.push({ url: imgUrl, bounds: meta.bounds, time: meta.time });
                    }
                } catch (e) { 
                    console.warn(`Frame ${i} not ready yet.`); 
                }
            }

            if (tempFrames.length > 0) {
                // newest first for the loop logic
                frames = tempFrames.reverse(); 
                document.getElementById('scrubber').max = frames.length - 1;
                document.getElementById('status').innerText = `Live (${frames.length} frames)`;
                if (!isPlaying) updateDisplay(currentIndex);
            } else {
                document.getElementById('status').innerText = "Waiting for first scan...";
            }
        }

        function updateDisplay(index) {
            if (!frames[index]) return;
            radarLayer.clearLayers();
            const frame = frames[index];
            L.imageOverlay(frame.url, frame.bounds, { opacity: 0.8 }).addTo(radarLayer);
            document.getElementById('time-label').innerText = frame.time;
            document.getElementById('scrubber').value = index;
        }

        function animate() {
            if (isPlaying && frames.length > 1) {
                currentIndex = (currentIndex + 1) % frames.length;
                updateDisplay(currentIndex);
            }
            setTimeout(() => requestAnimationFrame(animate), 800);
        }

        document.getElementById('playBtn').onclick = (e) => {
            isPlaying = !isPlaying;
            e.target.innerText = isPlaying ? "Pause" : "Play";
        };

        document.getElementById('scrubber').oninput = (e) => {
            isPlaying = false;
            document.getElementById('playBtn').innerText = "Play";
            currentIndex = parseInt(e.target.value);
            updateDisplay(currentIndex);
        };

        loadFrames();
        animate();
        setInterval(loadFrames, 60000); // Refresh every minute
    </script>
</body>
</html>
