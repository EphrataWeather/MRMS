<!DOCTYPE html>
<html>
<head>
    <title>MRMS Interactive Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #1a1a1a; font-family: sans-serif; color: white; }
        #map { height: 100vh; width: 100%; }
        #ui { position: absolute; top: 20px; right: 20px; z-index: 1000; background: rgba(30,30,30,0.9); padding: 20px; border-radius: 10px; width: 260px; border: 1px solid #444; }
        select, button { width: 100%; padding: 10px; margin: 10px 0; cursor: pointer; border-radius: 5px; border: none; }
        #status { color: #ffcc00; font-size: 0.85em; margin-bottom: 10px; }
        #timestamp { font-family: monospace; font-size: 1.2em; text-align: center; color: #00ffcc; }
    </style>
</head>
<body>

<div id="ui">
    <div id="status">Ready</div>
    <select id="prodType">
        <option value="reflectivity">Radar Reflectivity</option>
        <option value="precip">Precipitation Rate</option>
    </select>
    <button onclick="fetchData()">Load Latest Scans</button>
    <hr>
    <div id="timestamp">--:--:--</div>
    <input type="range" id="scrubber" min="0" max="0" value="0" style="width:100%" oninput="updateFrame(this.value)">
    <button id="playBtn" onclick="togglePlay()">Play Loop</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([38, -97], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    let frames = [];
    let layers = [];
    let index = 0;
    let timer = null;

   async function fetchData() {
    const type = document.getElementById('prodType').value;
    // We fetch the static file generated by the action
    const res = await fetch('manifest.json');
    const allData = await res.json();
    const data = allData[type]; // Get only the type we want
    
    // ... rest of your map logic remains exactly the same ...
}
        
        try {
            const type = document.getElementById('prodType').value;
            const res = await fetch(`/get_frames?type=${type}`);
            
            // This checks if the response is actually JSON
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new TypeError("Server sent HTML instead of JSON! Check Python console for errors.");
            }

            const data = await res.json();
            if (data.error) throw new Error(data.error);
            if (data.length === 0) throw new Error("No files found on NOAA server.");

            // Clear old layers
            layers.forEach(l => map.removeLayer(l));
            layers = [];
            frames = data;

            // Initialize layers
            frames.forEach(f => {
                const l = L.imageOverlay(f.url, f.bounds, { opacity: 0 });
                l.addTo(map);
                layers.push(l);
            });

            document.getElementById('scrubber').max = frames.length - 1;
            updateFrame(frames.length - 1);
            status.innerText = "Data Updated Successfully";
        } catch (e) {
            status.innerText = "Error: " + e.message;
            console.error(e);
        }
    }

    function updateFrame(val) {
        index = parseInt(val);
        layers.forEach((l, i) => l.setOpacity(i == index ? 0.75 : 0));
        
        const rawTime = frames[index].time; // YYYYMMDD-HHMMSS
        document.getElementById('timestamp').innerText = rawTime.split('-')[1].match(/.{1,2}/g).join(':');
        document.getElementById('scrubber').value = index;
    }

    function togglePlay() {
        if (timer) {
            clearInterval(timer);
            timer = null;
            document.getElementById('playBtn').innerText = "Play Loop";
        } else {
            document.getElementById('playBtn').innerText = "Pause";
            timer = setInterval(() => {
                index = (index + 1) % frames.length;
                updateFrame(index);
            }, 600);
        }
    }
</script>
</body>
</html>
