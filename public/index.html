<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Radar Loop</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #000; }
        
        /* Controls */
        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(20, 20, 20, 0.9);
            padding: 15px;
            border-radius: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            border: 1px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        button {
            background: #00fb90;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
        }
        button:hover { background: #00ce76; }
        input[type=range] { flex-grow: 1; cursor: pointer; accent-color: #00fb90; }
        .time-display {
            min-width: 85px;
            text-align: right;
            font-variant-numeric: tabular-nums;
            font-weight: bold;
            color: #00fb90;
        }

        /* Debug / Loader */
        #status-log {
            position: absolute;
            top: 10px; left: 10px;
            color: #0f0;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            z-index: 2000;
            border-radius: 4px;
            pointer-events: none;
            max-width: 300px;
        }
        .leaflet-image-layer { image-rendering: pixelated; }
    </style>
</head>
<body>

    <div id="status-log">Initializing Map...</div>

    <div class="controls">
        <button id="playBtn" onclick="togglePlay()">Pause</button>
        <input type="range" id="scrubber" min="0" max="0" value="0" step="1" oninput="scrub(this.value)">
        <div class="time-display" id="timeDisplay">--:--</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Setup Map (Dark Mode)
        const map = L.map('map', { zoomControl: false }).setView([39.8, -98.6], 4);
        
        // Dark Basemap
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: 'Map tiles by Carto, under CC BY 3.0. Data by OpenStreetMap, under ODbL.',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Labels on top
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 19,
            zIndex: 999
        }).addTo(map);

        let frames = [];
        let isPlaying = true;
        let currentIndex = 0;
        let timer = null;
        let radarLayer = L.layerGroup().addTo(map);
        let debugLayer = L.layerGroup().addTo(map);

        function log(msg) {
            const el = document.getElementById('status-log');
            el.innerHTML += `<br>${msg}`;
            console.log(msg);
        }

        async function initRadar() {
            log("Checking for data...");
            const tempFrames = [];
            const timestamp = Date.now(); // Cache buster

            // We look for metadata_0.json through metadata_9.json
            for (let i = 0; i < 10; i++) {
                try {
                    const metaUrl = `public/data/metadata_${i}.json?t=${timestamp}`;
                    const res = await fetch(metaUrl);
                    if (res.ok) {
                        const meta = await res.json();
                        // Frame 0 is master.png, others are master_X.png
                        // CRITICAL: We add ?t=... to the image URL to force reload image
                        const imgUrl = (i === 0 ? 'public/data/master.png' : `public/data/master_${i}.png`) + `?t=${timestamp}`;
                        
                        tempFrames.push({ 
                            url: imgUrl, 
                            bounds: meta.bounds, 
                            time: meta.time,
                            index: i
                        });
                        log(`Found Frame ${i}: ${meta.time}`);
                    }
                } catch (e) { 
                    // Frame missing, usually normal for startup
                }
            }

            if (tempFrames.length > 0) {
                // Reverse so index 0 is oldest time in the array
                frames = tempFrames.reverse();
                
                const slider = document.getElementById('scrubber');
                slider.max = frames.length - 1;
                slider.value = frames.length - 1;
                
                currentIndex = frames.length - 1; // Start at newest
                updateDisplay(currentIndex);
                startLoop();
                log(`Loaded ${frames.length} frames.`);
            } else {
                log("No data found yet. Retrying in 5s...");
                setTimeout(initRadar, 5000);
            }
        }

        function updateDisplay(index) {
            radarLayer.clearLayers();
            debugLayer.clearLayers();
            
            const frame = frames[index];
            if (frame) {
                // 1. Add Radar Image
                const img = L.imageOverlay(frame.url, frame.bounds, { 
                    opacity: 0.8, 
                    interactive: false 
                }).addTo(radarLayer);

                // 2. DEBUG: Draw a red box around where the image SHOULD be
                // If you see the red box but no radar, the image is transparent or failing to load
                // L.rectangle(frame.bounds, {color: "#ff0000", weight: 1, fill: false}).addTo(debugLayer);

                document.getElementById('timeDisplay').innerText = frame.time;
                document.getElementById('scrubber').value = index;
            }
        }

        function startLoop() {
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                if (!isPlaying) return;
                currentIndex = (currentIndex + 1) % frames.length;
                updateDisplay(currentIndex);
            }, 800);
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').innerText = isPlaying ? "PAUSE" : "PLAY";
        }

        function scrub(val) {
            isPlaying = false;
            document.getElementById('playBtn').innerText = "PLAY";
            currentIndex = parseInt(val);
            updateDisplay(currentIndex);
        }

        // Start
        initRadar();
        
        // Auto-refresh data every 5 minutes
        setInterval(() => {
            log("Refreshing data...");
            initRadar();
        }, 300000);

    </script>
</body>
</html>
