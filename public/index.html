<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live MRMS Radar Loop</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-color: #0b0b0b;
            --text-color: #ffffff;
            --accent-color: #00fb90;
        }
        body { margin: 0; padding: 0; background: var(--bg-color); font-family: sans-serif; }
        #map { height: 100vh; width: 100%; background: var(--bg-color); }

        /* UI Overlay */
        .overlay {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            color: var(--text-color);
            border: 1px solid #333;
            pointer-events: none;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            background: var(--accent-color);
            color: #000;
            margin-bottom: 5px;
        }

        #timestamp { font-size: 18px; font-weight: bold; display: block; }
        #frame-info { font-size: 12px; opacity: 0.7; }

        /* Loading Spinner */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        /* Sharp Radar Pixels */
        .leaflet-image-layer {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="loader">Updating Radar...</div>

    <div class="overlay">
        <div class="status-pill">LIVE MRMS</div>
        <span id="timestamp">Loading...</span>
        <span id="frame-info">Initializing loop...</span>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([38.0, -96.0], 4);

        // Dark-themed base map
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);
        // Add labels on top of radar
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { zIndex: 1000 }).addTo(map);

        let frames = [];
        let currentFrameIndex = 0;
        let layerGroup = L.layerGroup().addTo(map);
        const MAX_FRAMES = 5;

        async function loadFrames() {
            document.getElementById('loader').style.display = 'block';
            const loadedFrames = [];

            for (let i = 0; i < MAX_FRAMES; i++) {
                try {
                    // Try to fetch metadata for each frame (0-4)
                    const response = await fetch(`public/data/metadata_${i}.json?t=${Date.now()}`);
                    if (!response.ok) continue;
                    
                    const meta = await response.json();
                    // Each frame needs its own master image path
                    // Note: If you renamed your master images to master_0.png, master_1.png in Python, update here:
                    const imageUrl = i === 0 ? 'public/data/master.png' : `public/data/master_${i}.png`;
                    
                    loadedFrames.push({
                        url: imageUrl,
                        bounds: meta.bounds,
                        time: meta.time
                    });
                } catch (e) {
                    console.log(`Frame ${i} not found yet.`);
                }
            }

            if (loadedFrames.length > 0) {
                frames = loadedFrames.reverse(); // Show oldest to newest
                startLoop();
            }
            document.getElementById('loader').style.display = 'none';
        }

        function startLoop() {
            if (frames.length === 0) return;

            setInterval(() => {
                const frame = frames[currentFrameIndex];
                
                // Remove old radar images
                layerGroup.clearLayers();

                // Add current frame
                L.imageOverlay(frame.url, frame.bounds, {
                    opacity: 0.8,
                    interactive: false
                }).addTo(layerGroup);

                // Update UI
                document.getElementById('timestamp').innerText = frame.time;
                document.getElementById('frame-info').innerText = `Frame ${currentFrameIndex + 1} of ${frames.length}`;

                currentFrameIndex = (currentFrameIndex + 1) % frames.length;
            }, 800); // Speed of loop (800ms)
        }

        // Initial load
        loadFrames();
        
        // Refresh data every 5 minutes
        setInterval(loadFrames, 300000);
    </script>
</body>
</html>
