<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live MRMS Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #080808; font-family: sans-serif; color: white; }
        #map { height: 100vh; width: 100%; }
        .controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(0,0,0,0.8);
            padding: 15px; border-radius: 8px; z-index: 1000;
            display: flex; align-items: center; gap: 10px;
        }
        #status {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px; color: #00fb90;
        }
    </style>
</head>
<body>
    <div id="status">Checking for data...</div>
    <div class="controls">
        <button id="playBtn" style="padding: 5px 10px;">Pause</button>
        <input type="range" id="scrubber" min="0" value="0" style="flex-grow:1">
        <div id="time-label">--:--</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([38.5, -96.5], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let frames = [];
        let currentIndex = 0;
        let isPlaying = true;
        let radarLayer = L.layerGroup().addTo(map);

        // This matches the folder structure created by your YAML/Python
        const DATA_PATH = "public/data/";

        async function loadFrames() {
            const tempFrames = [];
            const ts = Date.now();

            // Try to load up to 10 historical frames
            for (let i = 0; i < 10; i++) {
                try {
                    // CRITICAL: Look for metadata_0.json, not metadata.json
                    const response = await fetch(`${DATA_PATH}metadata_${i}.json?t=${ts}`);
                    if (!response.ok) continue;
                    
                    const meta = await response.json();
                    const imgUrl = (i === 0 ? `${DATA_PATH}master.png` : `${DATA_PATH}master_${i}.png`) + `?t=${ts}`;
                    
                    tempFrames.push({ url: imgUrl, bounds: meta.bounds, time: meta.time });
                } catch (e) { break; }
            }

            if (tempFrames.length > 0) {
                frames = tempFrames.reverse(); // Show oldest to newest
                document.getElementById('scrubber').max = frames.length - 1;
                document.getElementById('status').innerText = `Radar Active: ${frames.length} frames`;
                render(currentIndex);
            } else {
                document.getElementById('status').innerText = "No radar data found in /public/data/";
            }
        }

        function render(index) {
            // Fix for "Cannot read properties of undefined (reading 'bounds')"
            if (!frames || !frames[index]) return;
            
            radarLayer.clearLayers();
            const f = frames[index];
            L.imageOverlay(f.url, f.bounds, { opacity: 0.7 }).addTo(radarLayer);
            document.getElementById('time-label').innerText = f.time || "";
            document.getElementById('scrubber').value = index;
        }

        function loop() {
            if (isPlaying && frames.length > 0) {
                currentIndex = (currentIndex + 1) % frames.length;
                render(currentIndex);
            }
            setTimeout(loop, 800);
        }

        document.getElementById('playBtn').onclick = () => isPlaying = !isPlaying;
        document.getElementById('scrubber').oninput = (e) => {
            isPlaying = false;
            currentIndex = parseInt(e.target.value);
            render(currentIndex);
        };

        loadFrames();
        loop();
        setInterval(loadFrames, 60000); // Check for new files every minute
    </script>
</body>
</html>
