<!DOCTYPE html>
<html>
<head>
    <title>Precision Weather Radar</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #050a14; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background: #050a14; }
        .leaflet-image-layer { image-rendering: pixelated; }

        /* --- GLASS UI --- */
        .glass-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(10, 25, 41, 0.85); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 15px 25px; border-radius: 20px;
            display: flex; flex-direction: column; gap: 10px; min-width: 350px; color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- DETAILED LEGEND --- */
        .legend-container {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(10, 25, 41, 0.9); backdrop-filter: blur(8px);
            padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            color: white; font-size: 11px; width: 140px;
        }
        .legend-title { font-weight: bold; margin-bottom: 8px; text-transform: uppercase; color: #a0aec0; letter-spacing: 1px; }
        
        .scale-row { display: flex; height: 12px; margin-bottom: 4px; border-radius: 2px; overflow: hidden; }
        .scale-item { flex: 1; height: 100%; }
        
        .scale-labels { display: flex; justify-content: space-between; margin-bottom: 12px; color: #ccc; font-size: 9px; }

        /* COLORS (Must match Python) */
        /* RAIN: Light Green -> Dark Green -> Yellow -> Orange -> Red -> Maroon */
        .rain-1 { background: #00fb90; } .rain-2 { background: #00bb00; }
        .rain-3 { background: #008800; } .rain-4 { background: #ffff00; }
        .rain-5 { background: #ff9100; } .rain-6 { background: #ff0000; }
        .rain-7 { background: #d20000; } .rain-8 { background: #910000; }

        /* SNOW: Cyan -> White -> Blue */
        .snow-1 { background: #00ffff; } .snow-2 { background: #ffffff; } .snow-3 { background: #5a82ff; }

        /* ICE: Pink -> Purple */
        .ice-1 { background: #ff00ff; } .ice-2 { background: #910091; }

        /* --- CONTROLS --- */
        .time-display { font-size: 20px; font-weight: 700; text-align: center; color: #00c6ff; text-shadow: 0 0 10px rgba(0,198,255,0.3); }
        .controls-row { display: flex; align-items: center; gap: 15px; margin-top: 5px; }
        
        button { background: #00c6ff; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        button:hover { background: #fff; transform: scale(1.1); }
        
        input[type=range] { flex-grow: 1; accent-color: #00c6ff; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="legend-container">
    <div class="legend-title">Rain Intensity</div>
    <div class="scale-row">
        <div class="scale-item rain-1"></div><div class="scale-item rain-2"></div>
        <div class="scale-item rain-3"></div><div class="scale-item rain-4"></div>
        <div class="scale-item rain-5"></div><div class="scale-item rain-6"></div>
        <div class="scale-item rain-7"></div><div class="scale-item rain-8"></div>
    </div>
    <div class="scale-labels"><span>Light</span><span>Heavy</span><span>Extreme</span></div>

    <div class="legend-title">Snow</div>
    <div class="scale-row">
        <div class="scale-item snow-1"></div><div class="scale-item snow-2"></div><div class="scale-item snow-3"></div>
    </div>

    <div class="legend-title" style="margin-top:8px;">Ice / Mix</div>
    <div class="scale-row">
        <div class="scale-item ice-1"></div><div class="scale-item ice-2"></div>
    </div>
</div>

<div class="glass-panel">
    <div id="clock" class="time-display">Loading Data...</div>
    <div class="controls-row">
        <button id="play-btn">⏸</button>
        <input type="range" id="scrubber" min="0" max="9" value="0">
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. MAP SETUP
    const map = L.map('map', { center: [38, -95], zoom: 5, zoomControl: false });
    
    // Dark Base
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);

    // Radar Pane (Below labels)
    map.createPane('radar');
    map.getPane('radar').style.zIndex = 200;
    map.getPane('radar').style.pointerEvents = 'none';

    // Labels (Above radar)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { pane: 'popupPane', zIndex: 600 }).addTo(map);

    // 2. STATE
    const TOTAL_FRAMES = 10;
    let frames = [];     // Stores image paths: [master.png, master_1.png...]
    let metaData = [];   // Stores time info: ["10:00 PM", "9:50 PM"...]
    let currentIdx = 0;  // 0 = Oldest, 9 = Newest (Reverse logic for smoother loop)
    let overlay = null;
    let timer = null;
    let isPlaying = true;

    async function init() {
        try {
            // Load Metadata for ALL frames to get their specific times
            // We iterate 0 to 9, where 0 is newest. 
            // BUT for the animation loop, we want 0 to be Oldest.
            // So we will fetch them, then REVERSE the arrays.
            
            const rawFrames = [];
            const rawMeta = [];

            for (let i = 0; i < TOTAL_FRAMES; i++) {
                const fName = i === 0 ? "master.png" : `master_${i}.png`;
                const mName = `metadata_${i}.json`; // Using new per-frame metadata
                
                rawFrames.push(`data/${fName}`);
                
                // Fetch the JSON for this specific frame
                const res = await fetch(`data/${mName}`);
                const data = await res.json();
                rawMeta.push(data);
            }

            // Reverse so Index 0 is the OLDEST time (start of loop)
            frames = rawFrames.reverse();
            metaData = rawMeta.reverse();

            // Initialize Overlay with the oldest frame (Index 0)
            overlay = L.imageOverlay(frames[0], metaData[0].bounds, { pane: 'radar', opacity: 0.8 }).addTo(map);
            
            updateDisplay(0);
            startLoop();

        } catch (e) {
            console.error(e);
            document.getElementById('clock').innerText = "RADAR OFFLINE";
            document.getElementById('clock').style.color = "red";
        }
    }

    function updateDisplay(index) {
        currentIdx = index;
        overlay.setUrl(frames[index]); // Leaflet handles the image swap
        document.getElementById('scrubber').value = index;
        document.getElementById('clock').innerText = metaData[index].time;
    }

    function startLoop() {
        isPlaying = true;
        document.getElementById('play-btn').innerText = "⏸";
        timer = setInterval(() => {
            let next = (currentIdx + 1) % TOTAL_FRAMES;
            updateDisplay(next);
        }, 600);
    }

    function pauseLoop() {
        isPlaying = false;
        document.getElementById('play-btn').innerText = "▶";
        clearInterval(timer);
    }

    // Toggle Play/Pause
    document.getElementById('play-btn').onclick = () => isPlaying ? pauseLoop() : startLoop();

    // Scrubber Interaction
    document.getElementById('scrubber').oninput = (e) => {
        pauseLoop();
        updateDisplay(parseInt(e.target.value));
    };

    init();
</script>
</body>
</html>
