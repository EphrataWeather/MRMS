<!DOCTYPE html>
<html>
<head>
    <title>Professional MRMS Radar</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; color: white; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; background: #0b1116; }
        .ui-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.8); padding: 15px 25px;
            border-radius: 50px; border: 1px solid #444; display: flex; align-items: center; gap: 20px;
        }
        #timestamp { font-weight: bold; min-width: 150px; text-align: center; color: #00e6ff; }
        .legend {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .color-box { width: 15px; height: 15px; margin-right: 8px; border-radius: 2px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
    <div id="timestamp">Loading Radar...</div>
</div>

<div class="legend">
    <div class="legend-item"><div class="color-box" style="background: #00bb00"></div> Rain</div>
    <div class="legend-item"><div class="color-box" style="background: #00ffff"></div> Snow</div>
    <div class="legend-item"><div class="color-box" style="background: #ff00ff"></div> Ice/Mix</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {
        center: [38, -97],
        zoom: 5,
        zoomControl: false
    });

    // Dark professional base map
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let frames = [];
    let currentFrameIndex = 0;
    let imageOverlay = null;

    async function initRadar() {
        try {
            // 1. Fetch metadata to get the geographical bounds
            const response = await fetch('data/metadata_0.json');
            const meta = await response.json();
            const bounds = meta.bounds; // [[latBot, lonLeft], [latTop, lonRight]]
            
            document.getElementById('timestamp').innerText = meta.time;

            // 2. Setup Frame list (0 to 9)
            // master.png is latest, master_1.png is older, etc.
            // We reverse them so the animation plays forward in time
            const frameNames = ['master.png', 'master_1.png', 'master_2.png', 'master_3.png', 'master_4.png', 'master_5.png'];
            frames = frameNames.reverse().map(name => `data/${name}`);

            // 3. Create the overlay
            imageOverlay = L.imageOverlay(frames[0], bounds, {
                opacity: 0.8,
                interactive: false
            }).addTo(map);

            // 4. Start Animation Loop
            setInterval(() => {
                currentFrameIndex = (currentFrameIndex + 1) % frames.length;
                imageOverlay.setUrl(frames[currentFrameIndex]);
                
                // If it's the latest frame, show the real time, otherwise show "Looping"
                if (currentFrameIndex === frames.length - 1) {
                    document.getElementById('timestamp').style.color = "#00e6ff";
                    document.getElementById('timestamp').innerText = meta.time;
                } else {
                    document.getElementById('timestamp').style.color = "#aaa";
                    document.getElementById('timestamp').innerText = "Past 60 mins...";
                }
            }, 600); // 600ms per frame

        } catch (e) {
            console.error("Error loading radar data:", e);
            document.getElementById('timestamp').innerText = "Radar Offline";
        }
    }

    initRadar();
</script>
</body>
</html>
