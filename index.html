<!DOCTYPE html>
<html>
<head>
    <title>High-Res Loop Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #0c0c0c; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; }
        .ui-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(20,20,20,0.95); padding: 15px 25px;
            border-radius: 50px; display: flex; align-items: center; gap: 20px;
            border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .legend {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(0,0,0,0.8); padding: 12px; border-radius: 8px; color: white;
        }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        #timeLabel { color: #00ff00; font-weight: bold; min-width: 80px; text-align: center; }
        button { background: #444; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #666; }
    </style>
</head>
<body>
    <div class="legend">
        <div><span class="dot" style="background:#00ff00"></span> Rain</div>
        <div><span class="dot" style="background:#ff00ff"></span> Mix / Ice</div>
        <div><span class="dot" style="background:#00ccff"></span> Snow</div>
    </div>

    <div class="ui-panel">
        <button onclick="togglePlay()" id="playBtn">Play Loop</button>
        <input type="range" id="slider" min="0" max="4" value="0" oninput="showFrame(this.value)">
        <span id="timeLabel">LIVE</span>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomSnap: 0.1 }).setView([38, -97], 4.5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let frames = []; // Array of layer groups
        let isPlaying = false;
        let loopTimer;

        async function init() {
            for(let i=0; i<5; i++) {
                const group = L.layerGroup().addTo(map);
                frames.push(group);
                try {
                    const r = await fetch(`data/metadata_${i}.json?t=${Date.now()}`);
                    const d = await r.json();
                    
                    const [s, w] = d.bounds[0];
                    const [n, e] = d.bounds[1];
                    const latStep = (n-s)/4;
                    const lonStep = (e-w)/4;

                    d.tiles.forEach(t => {
                        const ts = n - ((t.row + 1) * latStep);
                        const tn = n - (t.row * latStep);
                        const tw = w + (t.col * lonStep);
                        const te = w + ((t.col + 1) * lonStep);
                        // Using the path logic from the rotation
                        const url = `data/tiles_${i}/${t.url.split('/').pop()}`;
                        L.imageOverlay(url, [[ts, tw], [tn, te]], {opacity: 0.8}).addTo(group);
                    });
                } catch(err) { console.log(`Frame ${i} missing`); }
            }
            showFrame(0);
        }

        function showFrame(val) {
            frames.forEach((g, i) => {
                g.eachLayer(l => l.setOpacity(i == val ? 0.8 : 0));
            });
            document.getElementById('timeLabel').innerText = val == 0 ? "LIVE" : `-${val*10}m`;
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').innerText = isPlaying ? "Stop" : "Play Loop";
            if(isPlaying) {
                let c = 4;
                loopTimer = setInterval(() => {
                    showFrame(c);
                    document.getElementById('slider').value = c;
                    c = c <= 0 ? 4 : c - 1;
                }, 600);
            } else { clearInterval(loopTimer); }
        }

        init();
    </script>
</body>
</html>
